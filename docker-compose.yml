# VidScribe Docker Compose
# Complete development and production stack

services:
  # ===========================================================================
  # Application Services (Make sure to have .env file in root directory with all required variables)
  # ===========================================================================
  
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vidscribe-backend
    ports:
      - "8000:8000"
    environment:
      # MongoDB
      MONGO_URI: mongodb://admin:password@mongodb:27017
      DEFAULT_USERNAME: default
      # MinIO / S3
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_REGION: us-east-1
      S3_USE_SSL: "false"
      # Authentication
      SECRET_KEY: ${SECRET_KEY:-your-super-secret-key-change-in-production}
      TOKEN_EXPIRE_MINUTES: "1440"
      # Admin User
      ADMIN_USER_NAME: ${ADMIN_USER_NAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-PassWord@1234}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      # LLM (pass from host .env)
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-warning}
    volumes:
      - ./backend/outputs:/app/outputs
    depends_on:
      minio:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:8000
    container_name: vidscribe-frontend
    ports:
      - "5173:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================

  minio:
    image: minio/minio:latest
    container_name: vidscribe-minio
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  mongodb:
    image: mongo:latest
    container_name: vidscribe-mongodb
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# =============================================================================
# Volumes
# =============================================================================
volumes:
  minio_data:
    driver: local
  mongodb_data:
    driver: local
